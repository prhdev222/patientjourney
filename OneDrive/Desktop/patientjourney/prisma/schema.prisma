// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  username     String    @unique @db.VarChar(100)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         UserRole  @default(patient)
  department   String?   @db.VarChar(100)
  fullName     String?   @map("full_name") @db.VarChar(200)
  email        String?   @db.VarChar(255)
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login") @db.Timestamp(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  
  updatedJourneySteps JourneyStep[] @relation("UpdatedBy")
  
  @@map("users")
}

enum UserRole {
  admin
  staff
  patient
}

model PatientVisit {
  id            String   @id @default(uuid()) @db.Uuid
  vn            String   @unique @db.VarChar(20)
  hnHash        String   @map("hn_hash") @db.VarChar(255)
  qrCode        String?  @map("qr_code") @db.Text
  startTime     DateTime @default(now()) @map("start_time") @db.Timestamp(6)
  endTime       DateTime? @map("end_time") @db.Timestamp(6)
  currentStepId String?  @map("current_step_id") @db.Uuid
  fcmToken      String?  @map("fcm_token") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  journeySteps JourneyStep[]
  
  @@index([vn])
  @@index([createdAt])
  @@map("patient_visits")
}

model ServiceStep {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(100)
  nameEn          String?  @map("name_en") @db.VarChar(100)
  department      String   @db.VarChar(100)
  location        String?  @db.VarChar(200)
  floor           Int?
  estimatedMinutes Int     @default(30) @map("estimated_minutes")
  preparationText String?  @map("preparation_text") @db.Text
  preparationTextEn String? @map("preparation_text_en") @db.Text
  nextSteps       Json     @default("[]") @map("next_steps") @db.JsonB
  icon            String?  @db.VarChar(50)
  color           String?  @db.VarChar(7)
  isActive        Boolean  @default(true) @map("is_active")
  displayOrder    Int?     @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  journeySteps JourneyStep[]
  
  @@map("service_steps")
}

model JourneyStep {
  id          String          @id @default(uuid()) @db.Uuid
  visitId     String          @map("visit_id") @db.Uuid
  stepId      String          @map("step_id") @db.Uuid
  startTime   DateTime        @default(now()) @map("start_time") @db.Timestamp(6)
  endTime     DateTime?       @map("end_time") @db.Timestamp(6)
  status      JourneyStatus   @default(waiting)
  queueNumber Int?            @map("queue_number")
  notes       String?         @db.Text
  updatedById String?         @map("updated_by") @db.Uuid
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  
  visit      PatientVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  step       ServiceStep  @relation(fields: [stepId], references: [id])
  updatedBy  User?        @relation("UpdatedBy", fields: [updatedById], references: [id])
  
  @@index([visitId])
  @@index([status])
  @@map("journey_steps")
}

enum JourneyStatus {
  waiting
  in_progress
  completed
  skipped
}

